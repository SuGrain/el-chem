# 差分脉冲伏安法 (DPV) 通信协议文档

## 目录
1. [DPV 概述](#dpv-概述)
2. [通信规范](#通信规范)
3. [协议状态机](#协议状态机)
4. [命令格式](#命令格式)
5. [响应格式](#响应格式)
6. [完整通信流程](#完整通信流程)
7. [错误处理](#错误处理)
8. [数据格式](#数据格式)
9. [技术指标](#技术指标)
10. [附录](#附录)

---

## DPV 概述

差分脉冲伏安法（Differential Pulse Voltammetry, DPV）是一种电化学检测技术，通过施加规则脉冲并测量电流响应来检测物质浓度。本通信协议定义了主机与 DPV 电化学设备之间的串口通信方式。

### 主要特性
- 差分脉冲扫描
- 高灵敏度检测
- 约 50 Hz 数据采集频率
- 自动参数配置
- 实时数据流传输

---

## 通信规范

### 物理层

| 参数 | 值 | 说明 |
|------|-----|------|
| 接口 | RS232/USB | 串口通信 |
| 波特率 | 115200 | 默认波特率 |
| 数据位 | 8 | 标准配置 |
| 校验位 | N (无) | 无奇偶校验 |
| 停止位 | 1 | 1个停止位 |
| 超时 | 1s | 串口读取超时 |

### 数据层

- **编码格式**：UTF-8
- **行结束符**：\r\n (CRLF)
- **分隔符**：逗号 , (用于参数和数据字段分隔)
- **字段类型**：
  - 浮点数：电压值、电流值（4位小数精度）
  - 整数：参数值
  - 特殊符号：控制响应

---

## 协议状态机

### 状态定义

| 状态 | 值 | 说明 |
|------|-----|------|
| IDLE | 0 | 初始状态，未连接 |
| PARAMETER_SET | 1 | 参数已设置 |
| WAITING_ACK | 2 | 等待参数确认响应 |
| STARTING_TEST | 3 | 测试即将开始 |
| RECEIVING_DATA | 4 | 正在接收数据 |
| TEST_COMPLETE | 5 | 测试完成 |
| ERROR | 6 | 错误状态 |

### 状态转移

| 当前状态 | 事件 | 下一状态 |
|----------|------|--------|
| IDLE | 设备连接 | IDLE |
| IDLE | 发送参数 | PARAMETER_SET |
| PARAMETER_SET | 收到 # | WAITING_ACK |
| WAITING_ACK | 确认完成 | PARAMETER_SET |
| PARAMETER_SET | 发送开始命令 | STARTING_TEST |
| STARTING_TEST | 收到 * | RECEIVING_DATA |
| RECEIVING_DATA | 接收数据行 | RECEIVING_DATA |
| RECEIVING_DATA | 收到 @ | TEST_COMPLETE |
| 任何状态 | 异常 | ERROR |

---

## 命令格式

### DPV 参数设置命令

**格式：** P <参数1>,<参数2>,...,<参数19>,<结束符>

**完整参数列表：**

P <start_v>,<end_v>,<scan_dir>,<pulse_height>,<start_v2>,<cycles>,<vertex_v>,<param8>,<param9>,<param10>,<param11>,<pulse_width>,<pulse_period>,<sample_width>,<current_range>,<param16>,<param17>,<param18>,<end_marker>

### 参数详解

| 位置 | 参数名 | 类型 | 单位 | 范围 | 说明 |
|------|--------|------|------|------|------|
| 1 | start_v | float | V | -3.0~3.0 | 起始电位 |
| 2 | end_v | float | V | -3.0~3.0 | 结束电位 |
| 3 | scan_dir | int | - | 1/-1 | 扫描方向（1=正向，-1=负向） |
| 4 | pulse_height | float | V | 0.01~0.5 | 脉冲幅度 |
| 5 | start_v2 | float | V | -3.0~3.0 | 第二扫描起始点 |
| 6 | cycles | int | - | 1~100 | 循环次数 |
| 7 | vertex_v | float | V | -3.0~3.0 | 顶点电位（-1默认自动） |
| 8-11 | param8-11 | int | - | - | 保留参数 |
| 12 | pulse_width | int | ms | 1~100 | 脉冲宽度 |
| 13 | pulse_period | int | ms | 50~1000 | 脉冲周期 |
| 14 | sample_width | int | ms | 10~500 | 采样窗口宽度 |
| 15 | current_range | int | μA | 1~1000 | 电流量程 |
| 16-18 | param16-18 | int | - | - | 控制参数 |
| 19 | end_marker | char | - | 'D' | 命令结束标记 |

### 参数示例

发送命令：P -1,1,1,0.1,-1,2,-1,0,0,10,100,10,10,20,50,2,1,1,D

参数含义：
- 起始电位：-1 V
- 结束电位：1 V
- 扫描方向：正向 (1)
- 脉冲幅度：0.1 V
- 循环次数：2 次
- 脉冲宽度：10 ms
- 脉冲周期：10 ms
- 采样窗口：20 ms
- 电流量程：50 μA

---

## 响应格式

### 参数确认响应 (#)

**格式：** #\r\n

**含义：** 设备已收到并解析参数，参数配置成功

**期望后续状态：** PARAMETER_SET

### 开始响应 (*)

**格式：** *\r\n

**含义：** 设备已开始接收测试数据，DPV 扫描正在进行中

**期望后续状态：** RECEIVING_DATA

### 完成响应 (@)

**格式：** @\r\n

**含义：** 数据接收完成，DPV 扫描结束

**期望后续状态：** TEST_COMPLETE

### 扫描完成信号 ($)

**格式：** $\r\n

**含义：** DPV 扫描完成信号（等同于 @ 响应）

**期望后续状态：** TEST_COMPLETE

### 数据行 (Data)

**格式：** <voltage>,<current>,\r\n

**字段说明：**

| 字段 | 类型 | 单位 | 格式 | 说明 |
|------|------|------|------|------|
| voltage | float | V | -X.XXXX | 当前脉冲电位值 |
| current | float | μA | X.XX | 脉冲差分电流值 |

### 数据行示例

-1.0055,0.24,
-0.9958,0.08,
-0.9861,0.16,
-0.9765,-0.32,
-0.9668,0.40,

**特点：**
- 电压值：4位小数精度
- 电流值：2位小数精度
- 采集间隔：约 19.8 ms（50 Hz）
- 单次测试数据行数：约 200-250 行

---

## 完整通信流程

### 标准 DPV 测试流程

主机端通信流程：
1. 建立串口连接
2. 发送 DPV 参数设置命令 P <参数列表>,D
3. 等待参数确认响应 #\r\n
4. 发送启动命令 D
5. 等待开始响应 *\r\n
6. 循环接收数据行 <voltage>,<current>,\r\n
7. 接收完成响应 @\r\n
8. 处理数据并断开连接

### 时序示例

| 时间 | 事件 | 说明 |
|------|------|------|
| 00:00 | 连接设备 | 建立串口连接 |
| 00:01 | 发送参数 | 发送 P 命令 |
| 01:02 | 收到确认 | 收到 # 响应 |
| 01:03 | 发送启动 | 发送 D 命令 |
| 04:05 | 收到开始 | 收到 * 响应 |
| 05:10 | 接收数据 | 约 209 条数据行（5秒 × 50Hz） |
| 10:10 | 收到完成 | 收到 @ 响应 |
| 10:11 | 处理数据 | 保存和处理数据 |

---

## 错误处理

### 常见错误情况

| 错误 | 原因 | 解决方案 |
|------|------|--------|
| 连接失败 | 串口不存在或被占用 | 检查端口号，关闭其他应用 |
| 参数确认超时 | 设备未正确响应 | 检查波特率，重启设备 |
| 数据不完整 | 测试中断或超时 | 增加 timeout 值，检查设备 |
| 无效数据格式 | 串口数据损坏 | 检查波特率和线缆 |

### 超时处理

数据接收超时分类：
- **参数确认超时**：5秒内未收到 # 响应表示参数设置失败
- **测试数据超时**：60秒内未收到 @ 响应表示测试中断

### 异常处理

设备应在以下情况下返回错误或异常状态：
- 参数值超出范围
- 串口通信错误
- 测试过程中设备故障
- 数据接收中断

---

## 数据格式

### 数据特征

**数据点数量计算：**
- 电位扫描范围：从 start_v 到 end_v
- 脉冲周期：pulse_period (ms)
- 采集频率：约 50 Hz（每 20 ms 一条数据）
- 示例：-1V 到 1V 扫描，脉冲周期 10 ms → 约 200+ 数据点

**数据精度：**
- 电压精度：4 位小数（0.0001 V 级别）
- 电流精度：2 位小数（0.01 μA 级别）

### CSV 输出格式

标准 CSV 格式包含两列：电位(V) 和 电流(μA)

示例数据：
-1.0055,0.24
-0.9958,0.08
-0.9861,0.16
-0.9765,-0.32

### 文件命名规则

- **数据文件：** dpv_data_YYYYMMDD_HHMMSS.csv
- **图形文件：** dpv_curve_YYYYMMDD_HHMMSS.png

---

## 技术指标

### 性能

| 指标 | 值 |
|------|-----|
| 最大数据点率 | 50 Hz |
| 数据精度 | 4位小数（电压），2位小数（电流） |
| 响应延迟 | < 100 ms |
| 最大并发测试 | 1 |
| 脉冲宽度范围 | 1~100 ms |
| 脉冲周期范围 | 50~1000 ms |

### 兼容性

| 项目 | 值 |
|------|-----|
| 操作系统 | Windows, Linux, macOS |
| 串口接口 | RS232, USB Virtual COM |
| Python 版本 | 3.7+ |

---

## 附录

### A. DPV 参数范围表

| 参数 | 最小值 | 最大值 | 单位 | 说明 |
|------|--------|--------|------|------|
| start_v | -3.0 | 3.0 | V | 起始电位 |
| end_v | -3.0 | 3.0 | V | 结束电位 |
| pulse_height | 0.01 | 0.5 | V | 脉冲幅度 |
| pulse_width | 1 | 100 | ms | 脉冲宽度 |
| pulse_period | 50 | 1000 | ms | 脉冲周期 |
| sample_width | 10 | 500 | ms | 采样窗口宽度 |
| cycles | 1 | 100 | - | 循环次数 |
| current_range | 1 | 1000 | μA | 电流量程 |

